
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.1, mkdocs-material-7.1.9">
    
    
      
        <title>5. Replication - RKK1995's notes</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.ca7ac06f.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.f1a3b89f.min.css">
        
          
          
          <meta name="theme-color" content="#4051b5">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7C&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:""}</style>
      
    
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="indigo" data-md-color-accent="red">
  
    
    <script>function __prefix(e){return new URL("../../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#5-replication" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../index.html" title="RKK1995&#39;s notes" class="md-header__button md-logo" aria-label="RKK1995's notes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            RKK1995's notes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              5. Replication
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
      <div class="md-header__source">
        
<a href="https://github.com/rkk1995/Notes/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../../index.html" class="md-tabs__link">
      About the Site
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    

  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../papers/Storage/aurora.html" class="md-tabs__link md-tabs__link--active">
        Notes
      </a>
    </li>
  

  

  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../System%20Design/Problems/distributedCache.html" class="md-tabs__link">
        System Design
      </a>
    </li>
  

  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../index.html" title="RKK1995&#39;s notes" class="md-nav__button md-logo" aria-label="RKK1995's notes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    RKK1995's notes
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/rkk1995/Notes/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../index.html" class="md-nav__link">
        About the Site
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      <label class="md-nav__link" for="__nav_2">
        <span class="md-nav__icon md-icon"></span>
        
          Notes
        
      </label>
      <nav class="md-nav" aria-label="Notes" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          
            Notes
          
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" >
      
      <label class="md-nav__link" for="__nav_2_1">
        <span class="md-nav__icon md-icon"></span>
        
          Papers
        
      </label>
      <nav class="md-nav" aria-label="Papers" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          
            Papers
          
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1_1" type="checkbox" id="__nav_2_1_1" >
      
      <label class="md-nav__link" for="__nav_2_1_1">
        <span class="md-nav__icon md-icon"></span>
        
          Storage
        
      </label>
      <nav class="md-nav" aria-label="Storage" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_1_1">
          <span class="md-nav__icon md-icon"></span>
          
            Storage
          
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../papers/Storage/aurora.html" class="md-nav__link">
        Aurora
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../papers/Storage/craq.html" class="md-nav__link">
        CRAQ
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../papers/Storage/dynamo.html" class="md-nav__link">
        Dynamo
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../papers/Storage/farm.html" class="md-nav__link">
        FaRM
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../papers/Storage/frangipani.html" class="md-nav__link">
        Frangipani
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../papers/Storage/gfs.html" class="md-nav__link">
        GFS
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../papers/Storage/memcache.html" class="md-nav__link">
        Memcache
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../papers/Storage/spanner.html" class="md-nav__link">
        Spanner
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../papers/Storage/tao.html" class="md-nav__link">
        TAO
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1_2" type="checkbox" id="__nav_2_1_2" >
      
      <label class="md-nav__link" for="__nav_2_1_2">
        <span class="md-nav__icon md-icon"></span>
        
          Compute
        
      </label>
      <nav class="md-nav" aria-label="Compute" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_1_2">
          <span class="md-nav__icon md-icon"></span>
          
            Compute
          
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../papers/Compute/distributedTransactions.html" class="md-nav__link">
        Distributed Transactions
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../papers/Compute/mapreduce.html" class="md-nav__link">
        MapReduce
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1_3" type="checkbox" id="__nav_2_1_3" >
      
      <label class="md-nav__link" for="__nav_2_1_3">
        <span class="md-nav__icon md-icon"></span>
        
          Cluster Management
        
      </label>
      <nav class="md-nav" aria-label="Cluster Management" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_1_3">
          <span class="md-nav__icon md-icon"></span>
          
            Cluster Management
          
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../papers/Cluster%20Management/raft.html" class="md-nav__link">
        Raft
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../papers/Cluster%20Management/zookeeper.html" class="md-nav__link">
        ZooKeeper
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" checked>
      
      <label class="md-nav__link" for="__nav_2_2">
        <span class="md-nav__icon md-icon"></span>
        
          Books
        
      </label>
      <nav class="md-nav" aria-label="Books" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          
            Books
          
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2_1" type="checkbox" id="__nav_2_2_1" checked>
      
      <label class="md-nav__link" for="__nav_2_2_1">
        <span class="md-nav__icon md-icon"></span>
        
          DDIA
        
      </label>
      <nav class="md-nav" aria-label="DDIA" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_2_1">
          <span class="md-nav__icon md-icon"></span>
          
            DDIA
          
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="chapter1.html" class="md-nav__link">
        1. Reliable, scalable, and maintainable applications
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="chapter2.html" class="md-nav__link">
        2. Data Models and Query Languages
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="chapter3.html" class="md-nav__link">
        3. Storage and retrieval
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="chapter4.html" class="md-nav__link">
        4. Encoding and evolution
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          <span class="md-nav__icon md-icon"></span>
          
            <a href="chapter5.html" class="md-nav__link md-nav__link--active"
              style="margin: initial; padding: initial; pointer-events: initial">
          
            5. Replication
          </a>
        </label>
      
      <a href="chapter5.html" class="md-nav__link md-nav__link--active">
        5. Replication
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#leaders-and-followers" class="md-nav__link">
    Leaders and followers
  </a>
  
    <nav class="md-nav" aria-label="Leaders and followers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#synchronous-vs-asynchronous" class="md-nav__link">
    Synchronous vs asynchronous
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setting-up-new-followers" class="md-nav__link">
    Setting up new followers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-node-outages" class="md-nav__link">
    Handling node outages
  </a>
  
    <nav class="md-nav" aria-label="Handling node outages">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#follower-failure-catchup-recovery" class="md-nav__link">
    Follower failure: catchup recovery
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#leader-failure-failover" class="md-nav__link">
    Leader failure: failover
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-of-replication-logs" class="md-nav__link">
    Implementation of replication logs
  </a>
  
    <nav class="md-nav" aria-label="Implementation of replication logs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#statement-based-replication" class="md-nav__link">
    Statement-based replication
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#write-ahead-log-wal-shipping" class="md-nav__link">
    Write-ahead log (WAL) shipping
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logical-row-based-log-replication" class="md-nav__link">
    Logical (row-based) log replication
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trigger-based-replication" class="md-nav__link">
    Trigger-based replication
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#problems-with-replication-lag" class="md-nav__link">
    Problems with Replication Lag
  </a>
  
    <nav class="md-nav" aria-label="Problems with Replication Lag">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reading-your-own-writes" class="md-nav__link">
    Reading your own writes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monotonic-reads" class="md-nav__link">
    Monotonic reads
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consistent-prefix-reads" class="md-nav__link">
    Consistent prefix reads
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multi-leader-replication" class="md-nav__link">
    Multi-leader replication
  </a>
  
    <nav class="md-nav" aria-label="Multi-leader replication">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#use-cases-for-multi-leader-replication" class="md-nav__link">
    Use cases for multi-leader replication
  </a>
  
    <nav class="md-nav" aria-label="Use cases for multi-leader replication">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multi-datacenter-operation" class="md-nav__link">
    Multi-datacenter operation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients-with-offline-operation" class="md-nav__link">
    Clients with offline operation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#collaborative-editing" class="md-nav__link">
    Collaborative editing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-write-conflicts" class="md-nav__link">
    Handling write conflicts
  </a>
  
    <nav class="md-nav" aria-label="Handling write conflicts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#synchronous-vs-asynchronous-conflict-detection" class="md-nav__link">
    Synchronous vs asynchronous conflict detection
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conflict-avoidance" class="md-nav__link">
    Conflict avoidance
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#converging-toward-a-consistent-state" class="md-nav__link">
    Converging toward a consistent state
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-conflict-resolution" class="md-nav__link">
    Custom conflict resolution
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-leader-replication-topologies" class="md-nav__link">
    Multi-leader replication topologies
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#leaderless-replication" class="md-nav__link">
    Leaderless replication
  </a>
  
    <nav class="md-nav" aria-label="Leaderless replication">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#writing-to-the-database-when-a-node-is-down" class="md-nav__link">
    Writing to the Database When a Node Is Down
  </a>
  
    <nav class="md-nav" aria-label="Writing to the Database When a Node Is Down">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#read-repair-and-anti-entropy" class="md-nav__link">
    Read repair and anti-entropy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#quorums-for-reading-and-writing" class="md-nav__link">
    Quorums for reading and writing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sloppy-quorums-and-hinted-handoff" class="md-nav__link">
    Sloppy quorums and hinted handoff
  </a>
  
    <nav class="md-nav" aria-label="Sloppy quorums and hinted handoff">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multi-datacenter-operations" class="md-nav__link">
    Multi-datacenter operations
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detecting-concurrent-writes" class="md-nav__link">
    Detecting concurrent writes
  </a>
  
    <nav class="md-nav" aria-label="Detecting concurrent writes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#last-write-wins-discarding-concurrent-writes" class="md-nav__link">
    Last write wins (discarding concurrent writes)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-happens-before-relationship-and-concurrency" class="md-nav__link">
    The "happens-before" relationship and concurrency
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capturing-the-happens-before-relationship" class="md-nav__link">
    Capturing the happens-before relationship
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#merging-concurrently-written-values" class="md-nav__link">
    Merging concurrently written values
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#version-vectors" class="md-nav__link">
    Version vectors
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="chapter6.html" class="md-nav__link">
        6. Partitioning
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="chapter7.html" class="md-nav__link">
        7. Transactions
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="chapter8.html" class="md-nav__link">
        8. The Trouble With Distributed Systems
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3" type="checkbox" id="__nav_2_3" >
      
      <label class="md-nav__link" for="__nav_2_3">
        <span class="md-nav__icon md-icon"></span>
        
          Todo
        
      </label>
      <nav class="md-nav" aria-label="Todo" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          
            Todo
          
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../todo/articles.html" class="md-nav__link">
        TODO
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      <label class="md-nav__link" for="__nav_3">
        <span class="md-nav__icon md-icon"></span>
        
          System Design
        
      </label>
      <nav class="md-nav" aria-label="System Design" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          
            System Design
          
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1" type="checkbox" id="__nav_3_1" >
      
      <label class="md-nav__link" for="__nav_3_1">
        <span class="md-nav__icon md-icon"></span>
        
          Problems
        
      </label>
      <nav class="md-nav" aria-label="Problems" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          
            Problems
          
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../System%20Design/Problems/distributedCache.html" class="md-nav__link">
        Distributed Cache
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../System%20Design/Problems/distributedMessageQueue.html" class="md-nav__link">
        Distributed Message Queue
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../System%20Design/Problems/notificationService.html" class="md-nav__link">
        Notification Service
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../System%20Design/Problems/rateLimiting.html" class="md-nav__link">
        Rate Limiting (local and distributed)
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../System%20Design/Problems/stepByStepGuide.html" class="md-nav__link">
        Step By Step Guide
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../System%20Design/Problems/topKHeavyHitters.html" class="md-nav__link">
        Top K Heavy Hitters
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#leaders-and-followers" class="md-nav__link">
    Leaders and followers
  </a>
  
    <nav class="md-nav" aria-label="Leaders and followers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#synchronous-vs-asynchronous" class="md-nav__link">
    Synchronous vs asynchronous
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setting-up-new-followers" class="md-nav__link">
    Setting up new followers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-node-outages" class="md-nav__link">
    Handling node outages
  </a>
  
    <nav class="md-nav" aria-label="Handling node outages">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#follower-failure-catchup-recovery" class="md-nav__link">
    Follower failure: catchup recovery
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#leader-failure-failover" class="md-nav__link">
    Leader failure: failover
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-of-replication-logs" class="md-nav__link">
    Implementation of replication logs
  </a>
  
    <nav class="md-nav" aria-label="Implementation of replication logs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#statement-based-replication" class="md-nav__link">
    Statement-based replication
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#write-ahead-log-wal-shipping" class="md-nav__link">
    Write-ahead log (WAL) shipping
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logical-row-based-log-replication" class="md-nav__link">
    Logical (row-based) log replication
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trigger-based-replication" class="md-nav__link">
    Trigger-based replication
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#problems-with-replication-lag" class="md-nav__link">
    Problems with Replication Lag
  </a>
  
    <nav class="md-nav" aria-label="Problems with Replication Lag">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reading-your-own-writes" class="md-nav__link">
    Reading your own writes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monotonic-reads" class="md-nav__link">
    Monotonic reads
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consistent-prefix-reads" class="md-nav__link">
    Consistent prefix reads
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multi-leader-replication" class="md-nav__link">
    Multi-leader replication
  </a>
  
    <nav class="md-nav" aria-label="Multi-leader replication">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#use-cases-for-multi-leader-replication" class="md-nav__link">
    Use cases for multi-leader replication
  </a>
  
    <nav class="md-nav" aria-label="Use cases for multi-leader replication">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multi-datacenter-operation" class="md-nav__link">
    Multi-datacenter operation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients-with-offline-operation" class="md-nav__link">
    Clients with offline operation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#collaborative-editing" class="md-nav__link">
    Collaborative editing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-write-conflicts" class="md-nav__link">
    Handling write conflicts
  </a>
  
    <nav class="md-nav" aria-label="Handling write conflicts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#synchronous-vs-asynchronous-conflict-detection" class="md-nav__link">
    Synchronous vs asynchronous conflict detection
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conflict-avoidance" class="md-nav__link">
    Conflict avoidance
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#converging-toward-a-consistent-state" class="md-nav__link">
    Converging toward a consistent state
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-conflict-resolution" class="md-nav__link">
    Custom conflict resolution
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-leader-replication-topologies" class="md-nav__link">
    Multi-leader replication topologies
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#leaderless-replication" class="md-nav__link">
    Leaderless replication
  </a>
  
    <nav class="md-nav" aria-label="Leaderless replication">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#writing-to-the-database-when-a-node-is-down" class="md-nav__link">
    Writing to the Database When a Node Is Down
  </a>
  
    <nav class="md-nav" aria-label="Writing to the Database When a Node Is Down">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#read-repair-and-anti-entropy" class="md-nav__link">
    Read repair and anti-entropy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#quorums-for-reading-and-writing" class="md-nav__link">
    Quorums for reading and writing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sloppy-quorums-and-hinted-handoff" class="md-nav__link">
    Sloppy quorums and hinted handoff
  </a>
  
    <nav class="md-nav" aria-label="Sloppy quorums and hinted handoff">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multi-datacenter-operations" class="md-nav__link">
    Multi-datacenter operations
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detecting-concurrent-writes" class="md-nav__link">
    Detecting concurrent writes
  </a>
  
    <nav class="md-nav" aria-label="Detecting concurrent writes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#last-write-wins-discarding-concurrent-writes" class="md-nav__link">
    Last write wins (discarding concurrent writes)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-happens-before-relationship-and-concurrency" class="md-nav__link">
    The "happens-before" relationship and concurrency
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capturing-the-happens-before-relationship" class="md-nav__link">
    Capturing the happens-before relationship
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#merging-concurrently-written-values" class="md-nav__link">
    Merging concurrently written values
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#version-vectors" class="md-nav__link">
    Version vectors
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/rkk1995/Notes/edit/master/docs/Notes/books/DDIA/chapter5.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="5-replication">5. Replication</h1>
<p>Reasons why you might want to replicate data:</p>
<ul>
<li>To keep data geographically close to your users</li>
<li>Increase availability</li>
<li>Increase read throughput</li>
</ul>
<p>The difficulty in replication lies in handling <em>changes</em> to replicated data. Popular algorithms for replicating changes between nodes: <em>single-leader</em>, <em>multi-leader</em>, and <em>leaderless</em> replication.</p>
<h2 id="leaders-and-followers">Leaders and followers</h2>
<p>Each node that stores a copy of the database is called a <em>replica</em>.</p>
<p>Every write to the database needs to be processed by every replica. The most common solution for this is called <em>leader-based replication</em> (<em>active/passive</em> or <em>master-slave replication</em>).</p>
<ol>
<li>One of the replicas is designated the <em>leader</em> (<em>master</em> or <em>primary</em>). Writes to the database must send requests to the leader.</li>
<li>Other replicas are known as <em>followers</em> (<em>read replicas</em>, <em>slaves</em>, <em>secondaries</em> or <em>hot stanbys</em>). The leader sends the data change to all of its followers as part of a <em>replication log</em> or <em>change stream</em>.</li>
<li>Reads can be query the leader or any of the followers, while writes are only accepted on the leader.</li>
</ol>
<p>MySQL, Oracle Data Guard, SQL Server's AlwaysOn Availability Groups, MongoDB, RethinkDB, Espresso, Kafka and RabbitMQ are examples of these kind of databases.</p>
<h3 id="synchronous-vs-asynchronous">Synchronous vs asynchronous</h3>
<p>The advantage of synchronous replication is that the follower is guaranteed to have an up-to-date copy of the data that is consistent with the leader. The disadvantage is that it the synchronous follower doesn't respond, the write cannot be processed.</p>
<p>It's impractical for all followers to be synchronous. If you enable synchronous replication on a database, it usually means that <em>one</em> of the followers is synchronous, and the others are asynchronous. This guarantees up-to-date copy of the data on at least two nodes (this is sometimes called <em>semi-synchronous</em>).</p>
<p>Often, leader-based replication is asynchronous. Writes are not guaranteed to be durable, the main advantage of this approach is that the leader can continue processing writes.</p>
<h3 id="setting-up-new-followers">Setting up new followers</h3>
<p>Copying data files from one node to another is typically not sufficient.</p>
<p>Setting up a follower can usually be done without downtime. The process looks like:</p>
<ol>
<li>Take a snapshot of the leader's database</li>
<li>Copy the snapshot to the follower node</li>
<li>Follower requests data changes that have happened since the snapshot was taken</li>
<li>Once follower processed the backlog of data changes since snapshot, it has <em>caught up</em>.</li>
</ol>
<h3 id="handling-node-outages">Handling node outages</h3>
<p>How does high availability work with leader-based replication?</p>
<h4 id="follower-failure-catchup-recovery">Follower failure: catchup recovery</h4>
<p>On its local disk, each follower keeps a log of the data changes it has received from
the leader. If a follower crashes and is restarted, or if the network between the leader
and the follower is temporarily interrupted, the follower can recover quite easily:
from its log, it knows the last transaction that was processed before the fault occur‐
red. Thus, the follower can connect to the leader and request all the data changes that
occurred during the time when the follower was disconnected. When it has applied
these changes, it has caught up to the leader and can continue receiving a stream of
data changes as before.</p>
<h4 id="leader-failure-failover">Leader failure: failover</h4>
<dl>
<dt>Failover</dt>
<dd>One of the followers needs to be promoted to be the new leader, clients need to be reconfigured to send their writes to the new leader and followers need to start consuming data changes from the new leader.</dd>
</dl>
<p>Automatic failover consists:</p>
<ol>
<li>Determining that the leader has failed. If a node does not respond in a period of time it's considered dead.</li>
<li>Choosing a new leader. The best candidate for leadership is usually the replica with the most up-to-date changes from the old leader.</li>
<li>Reconfiguring the system to use the new leader. The system needs to ensure that the old leader becomes a follower and recognises the new leader.</li>
</ol>
<p>Things that could go wrong:</p>
<ul>
<li>If asynchronous replication is used, the new leader may have received conflicting writes in the meantime.</li>
<li>Discarding writes is especially dangerous if other storage systems outside of the database need to be coordinated with the database contents.</li>
<li>It could happen that two nodes both believe that they are the leader (<em>split brain</em>). Data is likely to be lost or corrupted.</li>
<li>What is the right time before the leader is declared dead? A longer timeout
means a longer time to recovery in the case where the leader fails. However, if the
timeout is too short, there could be unnecessary failovers.</li>
</ul>
<p>For these reasons, some operation teams prefer to perform failovers manually, even if the software supports automatic failover.</p>
<h3 id="implementation-of-replication-logs">Implementation of replication logs</h3>
<h4 id="statement-based-replication">Statement-based replication</h4>
<p>The leader logs every <em>statement</em> and sends it to its followers (every <code>INSERT</code>, <code>UPDATE</code> or <code>DELETE</code>).</p>
<p>This type of replication has some problems:</p>
<ul>
<li>Non-deterministic functions such as <code>NOW()</code> or <code>RAND()</code> will generate different values on replicas.</li>
<li>Statements that depend on existing data, like auto-increments, must be executed in the same order in each replica.</li>
<li>Statements with side effects may result on different results on each replica.</li>
</ul>
<p>A solution to this is to replace any nondeterministic function with a fixed return value in the leader. However, because there are so many edge cases, other replication methods are now generally preferred.</p>
<h4 id="write-ahead-log-wal-shipping">Write-ahead log (WAL) shipping</h4>
<p>The log is an append-only sequence of bytes containing all writes to the database. The leader can send it to its followers. This way of replication is used in PostgresSQL and Oracle.</p>
<p>The main disadvantage is that the log describes the data at a very low level (like which bytes were changed in which disk blocks), coupling it to the storage engine.</p>
<p>Usually is not possible to run different versions of the database in leaders and followers. This can have a big operational impact, like making it impossible to have a zero-downtime upgrade of the database.</p>
<h4 id="logical-row-based-log-replication">Logical (row-based) log replication</h4>
<p>Basically a sequence of records describing writes to database tables at the granularity of a row:</p>
<ul>
<li>For an inserted row, the new values of all columns.</li>
<li>For a deleted row, the information that uniquely identifies that column.</li>
<li>For an updated row, the information to uniquely identify that row and all the new values of the columns.</li>
</ul>
<p>A transaction that modifies several rows, generates several of such logs, followed by a record indicating that the transaction was committed. MySQL binlog uses this approach.</p>
<p>Since logical log is decoupled from the storage engine internals, it's easier to make it backwards compatible.</p>
<p>Logical logs are also easier for external applications to parse, useful for data warehouses, custom indexes and caches (<em>change data capture</em>).</p>
<h4 id="trigger-based-replication">Trigger-based replication</h4>
<p>There are some situations were you may need to move replication up to the application layer.</p>
<p>A trigger lets you register custom application code that is automatically executed when a data change occurs. This is a good opportunity to log this change into a separate table, from which it can be read by an external process.</p>
<p>Main disadvantages is that this approach has greater overheads, is more prone to bugs but it may be useful due to its flexibility.</p>
<h2 id="problems-with-replication-lag">Problems with Replication Lag</h2>
<p>Being able to tolerate node failures is just one reason for wanting replication. As
mentioned in the introduction to Part II, other reasons are scalability (processing
more requests than a single machine can handle) and latency (placing replicas geographically closer to users)</p>
<p>In a <em>read-scaling</em> architecture, you can increase the capacity for serving read-only requests simply by adding more followers. However, this only realistically works on asynchronous replication. The more nodes you have, the likelier is that one will be down, so a fully synchronous configuration would be unreliable.</p>
<p>With an asynchronous approach, a follower may fall behind, leading to inconsistencies in the database (<em>eventual consistency</em>). The <em>replication lag</em> could be a fraction of a second or several seconds or even minutes.</p>
<p>The problems that may arise and how to solve them.</p>
<h3 id="reading-your-own-writes">Reading your own writes</h3>
<dl>
<dt>Read-after-write consistency</dt>
<dd>also known as <em>read-your-writes consistency</em> is a guarantee that if the user reloads the page, they will always see any updates they submitted themselves.</dd>
</dl>
<p>How to implement it:</p>
<ul>
<li>When reading something that the user may have modified, read it from the leader. For example, user profile information on a social network is normally only editable by the owner. A simple rule is always read the user's own profile from the leader.</li>
<li>If most things in the application are potentially editable by the user, that approach won’t be effective, as most things would have to be read from the leader (negating the benefit of read scaling).  In that case, other criteria may be used to decide whether to read from the leader. You could track the time of the latest update and, for one minute after the last update, make all reads from the leader.</li>
<li>The client can remember the timestamp of the most recent write, then the system can ensure that the replica serving any reads for that user reflects updates at least until that timestamp.</li>
<li>If your replicas are distributed across multiple datacenters, then any request needs to be routed to the datacenter that contains the leader.</li>
</ul>
<p>Another complication is that the same user is accessing your service from multiple devices, you may want to provide <em>cross-device</em> read-after-write consistency.</p>
<p>Some additional issues to consider:</p>
<ul>
<li>Remembering the timestamp of the user's last update becomes more difficult because the code running on one device doesn’t know what updates have happened on the other device. . The metadata will need to be centralised.</li>
<li>If replicas are distributed across datacenters, there is no guarantee that connections from different devices will be routed to the same datacenter. You may need to route requests from all of a user's devices to the same datacenter.</li>
</ul>
<p>See Facebooks memcached implementation for how they implement this with a cache layer aswell.</p>
<h3 id="monotonic-reads">Monotonic reads</h3>
<p>Because of followers falling behind, it's possible for a user to see things <em>moving backward in time</em>.</p>
<p>When you read data, you may see an old value; monotonic reads only means that if one user makes several reads in sequence, they will not see time go backward. It’s a lesser guarantee than strong consistency, but a stronger guarantee than eventual consistency.</p>
<p>Make sure that each user always makes their reads from the same replica. The replica can be chosen based on a hash of the user ID. If the replica fails, the user's queries will need to be rerouted to another replica.</p>
<h3 id="consistent-prefix-reads">Consistent prefix reads</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>Mr. Poons
    How far into the future can you see, Mrs. Cake?
Mrs. Cake
    About ten seconds usually, Mr. Poons.
</code></pre></div>
</td></tr></table>
<p>Someone shouldn't see Mrs. Cake's message first. Preventing this kind of anomaly requires another type of guarantee: consistent prefix reads. This guarantee says that if a sequence of writes happens in a certain order, then anyone reading those writes will see them appear in the same order.</p>
<p>If the database always applies writes in the same order, reads always see a consistent prefix, so this anomaly cannot happen. However, in many distributed databases, different partitions operate independently, so there is no global ordering of writes: when a user reads from the database, they may see some parts of the database in an older state and some in a newer state.</p>
<p>One solution is to make sure that any writes that are causally related to each other are
written to the same partition—but in some applications that cannot be done efficiently. There are also algorithms that explicitly keep track of causal dependencies, a topic that we will return to in “The “happens-before” relationship and concurrency”.</p>
<h2 id="multi-leader-replication">Multi-leader replication</h2>
<p>Leader-based replication has one major downside: there is only one leader, and all writes must go through it.</p>
<p>A natural extension is to allow more than one node to accept writes (<em>multi-leader</em>, <em>master-master</em> or <em>active/active</em> replication) where each leader simultaneously acts as a follower to the other leaders.</p>
<h3 id="use-cases-for-multi-leader-replication">Use cases for multi-leader replication</h3>
<p>It rarely makes sense to use multi-leader setup within a single datacenter.</p>
<h4 id="multi-datacenter-operation">Multi-datacenter operation</h4>
<p>You can have a leader in <em>each</em> datacenter. Within each datacenter, regular leader-follower replication is used. Between datacenters, each datacenter leader replicates its changes to the leaders in other datacenters.</p>
<p><img alt="Figure 5-6" src="images/5/5-6.png" /></p>
<p>Compared to a single-leader replication model deployed in multi-datacenters</p>
<dl>
<dt>Performance</dt>
<dd>With single-leader, every write must go across the internet to wherever the leader is, adding significant latency. In multi-leader every write is processed in the local datacenter and replicated asynchronously to other datacenters. The network delay is hidden from users and perceived performance may be better.</dd>
<dt>Tolerance of datacenter outages</dt>
<dd>In single-leader if the datacenter with the leader fails, failover can promote a follower in another datacenter. In multi-leader, each datacenter can continue operating independently from others.</dd>
<dt>Tolerance of network problems</dt>
<dd>Traffic between datacenters usually goes over the public internet, which may be
less reliable than the local network within a datacenter. Single-leader is very sensitive to problems in this inter-datacenter link as writes are made synchronously over this link. Multi-leader with asynchronous replication can tolerate network problems better.</dd>
</dl>
<p>Multi-leader replication is implemented with Tungsten Replicator for MySQL, BDR for PostgreSQL or GoldenGate for Oracle.</p>
<p>Although multi-leader replication has advantages, it also has a big downside: the same data may be concurrently modified in two different datacenters, and those write conflicts must be resolved (indicated as “conflict resolution” in Figure 5-6). </p>
<p>Traffic between datacenters usually goes over the public internet, which may be
less reliable than the local network within a datacenter
It's common to fall on subtle configuration pitfalls. Autoincrementing keys, triggers and integrity constraints can be problematic. Multi-leader replication is often considered dangerous territory and avoided if possible.</p>
<h4 id="clients-with-offline-operation">Clients with offline operation</h4>
<p>If you have an application that needs to continue to work while it is disconnected from the internet, every device that has a local database can act as a leader, and there will be some asynchronous multi-leader replication process (imagine, a Calendar application).</p>
<p>CouchDB is designed for this mode of operation.</p>
<h4 id="collaborative-editing">Collaborative editing</h4>
<p><em>Real-time collaborative editing</em> applications allow several people to edit a document simultaneously. Like Etherpad or Google Docs.</p>
<p>The user edits a document, the changes are instantly applied to their local replica and asynchronously replicated to the server and any other user.</p>
<p>If you want to avoid editing conflicts, you must the lock the document before a user can edit it. For faster collaboration, you may want to make the unit of change very small (like a keystroke) and avoid locking. This approach allows multiple users to edit simultaneously, but it also brings all the challenges of multi-leader replication, including requiring conflict resolution</p>
<h3 id="handling-write-conflicts">Handling write conflicts</h3>
<p>The biggest problem with multi-leader replication is when conflict resolution is required. This problem does not happen in a single-leader database.</p>
<h4 id="synchronous-vs-asynchronous-conflict-detection">Synchronous vs asynchronous conflict detection</h4>
<p>In single-leader the second writer can be blocked and wait the first one to complete, forcing the user to retry the write. On multi-leader if both writes are successful, the conflict is only detected asynchronously later in time.</p>
<p>In principle, you could make the conflict detection synchronous—i.e., wait for the write to be replicated to all replicas before telling the user that the write was successful. However, by doing so, you would lose the main advantage of multi-leader replication: allowing each replica to accept writes independently. If you want synchronous conflict detection, you might as well just use single-leader replication.</p>
<h4 id="conflict-avoidance">Conflict avoidance</h4>
<p>The simplest strategy for dealing with conflicts is to avoid them. If all writes for a particular record go through the sane leader, then conflicts cannot occur.</p>
<p>On an application where a user can edit their own data, you can ensure that requests from a particular user are always routed to the same datacenter and use the leader in that datacenter for reading and writing.</p>
<h4 id="converging-toward-a-consistent-state">Converging toward a consistent state</h4>
<p>On single-leader, the last write determines the final value of the field.</p>
<p>In multi-leader, it's not clear what the final value should be.</p>
<p>The database must resolve the conflict in a <em>convergent</em> way, all replicas must arrive a the same final value when all changes have been replicated.</p>
<p>Different ways of achieving convergent conflict resolution.</p>
<ul>
<li>Give each write a unique ID (timestamp, long random number, UUID, or a has of the key and value), pick the write with the highest ID as the <em>winner</em> and throw away the other writes. This is known as <em>last write wins</em> (LWW) and it is dangerously prone to data loss.</li>
<li>Give each replica a unique ID, writes that originated at a higher-numbered replica always take precedence. This approach also implies data loss.</li>
<li>Somehow merge the values together.</li>
<li>Record the conflict and write application code that resolves it a to some later time (perhaps prompting the user).</li>
</ul>
<h4 id="custom-conflict-resolution">Custom conflict resolution</h4>
<p>Multi-leader replication tools let you write conflict resolution logic using application code.</p>
<dl>
<dt>On write</dt>
<dd>As soon as the database system detects a conflict in the log of replicated changes, it calls the conflict handler.</dd>
<dt>On read</dt>
<dd>All the conflicting writes are stored. On read, multiple versions of the data are returned to the application. The application may prompt the user or automatically resolve the conflict. CouchDB works this way.</dd>
</dl>
<h3 id="multi-leader-replication-topologies">Multi-leader replication topologies</h3>
<p>A <em>replication topology</em> describes the communication paths along which writes are propagated from one node to another.</p>
<p>The most general topology is <em>all-to-all</em> in which every leader sends its writes to every other leader. MySQL uses <em>circular topology</em>, where each nodes receives writes from one node and forwards those writes to another node. Another popular topology has the shape of a <em>star</em>, one designated node forwards writes to all of the other nodes.</p>
<p>In circular and star topologies a write might need to pass through multiple nodes before they reach all replicas. To prevent infinite replication loops each node is given a unique identifier and the replication log tags each write with the identifiers of the nodes it has passed through. When a node fails it can interrupt the flow of replication messages.</p>
<p>In all-to-all topology fault tolerance is better as messages can travel along different paths avoiding a single point of failure. It has some issues too, some network links may be faster than others and some replication messages may "overtake" others. To order events correctly. there is a technique called <em>version vectors</em>. PostgresSQL BDR does not provide casual ordering of writes, and Tungsten Replicator for MySQL doesn't even try to detect conflicts.</p>
<h2 id="leaderless-replication">Leaderless replication</h2>
<p>Simply put, any replica can directly accept writes from clients. Databases like look like Amazon's in-house <em>Dynamo</em> datastore. <em>Riak</em>, <em>Cassandra</em> and <em>Voldemort</em> follow the <em>Dynamo style</em>.</p>
<h3 id="writing-to-the-database-when-a-node-is-down">Writing to the Database When a Node Is Down</h3>
<p>In a leaderless configuration, failover does not exist. Clients send the write to w replicas in parallel.</p>
<p><em>Read requests are also sent to several nodes in parallel</em>. The client may get different responses. Version numbers are used to determine which value is newer.</p>
<p>Eventually, all the data is copied to every replica. After a unavailable node comes back online, it has two different mechanisms to catch up:</p>
<h4 id="read-repair-and-anti-entropy">Read repair and anti-entropy</h4>
<ul>
<li><strong>Read repair.</strong> When a client makes a read from several nodes in parallel, it can detect any stale responses. This approach works well for values that are frequently read.</li>
<li><strong>Anti-entropy process.</strong> There is a background process that constantly looks for differences in data between replicas and copies any missing data from one replica to he other. It does not copy writes in any particular order.</li>
</ul>
<h4 id="quorums-for-reading-and-writing">Quorums for reading and writing</h4>
<p>If there are <em>n</em> replicas, every write must be confirmed by <em>w</em> nodes to be considered successful, and we must query at least <em>r</em> nodes for each read. As long as <em>w</em> + <em>r</em> &gt; <em>n</em>, we expect to get an up-to-date value when reading.  <em>r</em> and <em>w</em> values are called <em>quorum</em> reads and writes. <script type="math/tex"> r </script> and <script type="math/tex"> w </script> are the minimum number of votes required for the read or write to be valid.</p>
<p>A common choice is to make <em>n</em> and odd number (typically 3 or 5) and to set <em>w</em> = <em>r</em> = (<em>n</em> + 1)/2 (rounded up). For example, a workload with few writes and many reads may benefit from setting w = n and r = 1. This makes reads faster, but has the disadvantage that just one failed node causes all database writes to fail.</p>
<p>Limitations:</p>
<ul>
<li>Sloppy quorum, the <em>w</em> writes may end up on different nodes than the <em>r</em> reads, so there is no longer a guaranteed overlap.</li>
<li>If two writes occur concurrently, and is not clear which one happened first, the only safe solution is to merge them. Writes can be lost due to clock skew.</li>
<li>If a write happens concurrently with a read, the write may be reflected on only some of the replicas.</li>
<li>If a write succeeded on some replicas but failed on others, it is not rolled back on the replicas where it succeeded. Reads may or may not return the value from that write.</li>
<li>If a node carrying a new value fails, and its data is restored from a replica carrying an old value, the number of replicas storing the new value may break the quorum condition.</li>
</ul>
<p><strong>Dynamo-style databases are generally optimised for use cases that can tolerate eventual consistency.</strong></p>
<h3 id="sloppy-quorums-and-hinted-handoff">Sloppy quorums and hinted handoff</h3>
<p>Leaderless replication may be appealing for use cases that require high availability and low latency, and that can tolerate occasional stale reads.</p>
<p>It's likely that the client won't be able to connect to <em>some</em> database nodes during a network interruption.</p>
<ul>
<li>Is it better to return errors to all requests for which we cannot reach quorum of <em>w</em> or <em>r</em> nodes?</li>
<li>Or should we accept writes anyway, and write them to some nodes that are reachable but aren't among the <em>n</em> nodes on which the value usually lives?</li>
</ul>
<p>The latter is known as <em>sloppy quorum</em>: writes and reads still require <em>w</em> and <em>r</em> successful responses, but those may include nodes that are not among the designated <em>n</em> "home" nodes for a value.</p>
<p>Once the network interruption is fixed, any writes are sent to the appropriate "home" nodes (<em>hinted handoff</em>).</p>
<p>Sloppy quorums are useful for increasing write availability: as long as any <em>w</em> nodes are available, the database can accept writes. This also means that you cannot be sure to read the latest value for a key, because it may have been temporarily written to some nodes outside of <em>n</em>.</p>
<p>Sloppy quorums are optional in all common Dynamo implementations. In Riak they
are enabled by default, and in Cassandra and Voldemort they are disabled by default.</p>
<h4 id="multi-datacenter-operations">Multi-datacenter operations</h4>
<p>Each write from a client is sent to all replicas, regardless of datacenter, but the client usually only waits for acknowledgement from a quorum of nodes within its local datacenter so that it is unaffected by delays and interruptions on cross-datacenter link. The higher-latency writes to other datacenters are often configured to happen asynchronously, although there is some flexibility in the configuration</p>
<h3 id="detecting-concurrent-writes">Detecting concurrent writes</h3>
<p>In order to become eventually consistent, the replicas should converge toward the same value. If you want to avoid losing data, you application developer, need to know a lot about the internals of your database's conflict handling.</p>
<h4 id="last-write-wins-discarding-concurrent-writes">Last write wins (discarding concurrent writes)</h4>
<p>Even though the writes don't have a natural ordering, we can force an arbitrary order on them. We can attach a timestamp to each write and pick the most recent. There are some situations such caching on which lost writes are acceptable. If losing data is not acceptable, LWW is a poor choice for conflict resolution.</p>
<h4 id="the-happens-before-relationship-and-concurrency">The "happens-before" relationship and concurrency</h4>
<p>An operation A happens before another operation B if B knows about A, or depends
on A, or builds upon A in some way. Whether one operation happens before another operation is the key to defining what concurrency means. <strong>We can simply say that to operations are <em>concurrent</em> if neither happens before the other.</strong> Either A happened before B, or B happened before A, or A and B are concurrent.</p>
<h4 id="capturing-the-happens-before-relationship">Capturing the happens-before relationship</h4>
<p>The server can determine whether two operations are concurrent by looking at the version numbers.</p>
<ul>
<li>The server maintains a version number for every key, increments the version number every time that key is written, and stores the new version number along the value written.</li>
<li>Client reads a key, the server returns all values that have not been overwritten, as well as the latest version number. A client must read a key before writing.</li>
<li>Client writes a key, it must include the version number from the prior read, and it must merge together all values that it received in the prior read.</li>
<li>Server receives a write with a particular version number, it can overwrite all values with that version number or below, but it must keep all values with a higher version number.</li>
</ul>
<h4 id="merging-concurrently-written-values">Merging concurrently written values</h4>
<p>No data is silently dropped. It requires clients do some extra work, they have to clean up afterward by merging the concurrently written values. Riak calls these concurrent values <em>siblings</em>.</p>
<p>Merging sibling values is the same problem as conflict resolution in multi-leader replication. A simple approach is to just pick one of the values on a version number or timestamp (last write wins). You may need to do something more intelligent in application code to avoid losing data.</p>
<p>If you want to allow people to <em>remove</em> things, union of siblings may not yield the right result. An item cannot simply be deleted from the database when it is removed, the system must leave a marker with an appropriate version number to indicate that the item has been removed when merging siblings (<em>tombstone</em>).</p>
<p>Merging siblings in application code is complex and error-prone, there are efforts to design data structures that can perform this merging automatically (CRDTs).</p>
<h3 id="version-vectors">Version vectors</h3>
<p>We need a version number <em>per replica</em> as well as per key. Each replica increments its own version number when processing a write, and also keeps track of the version numbers it has seen from each of the other replicas.</p>
<p>The collection of version numbers from all the replicas is called a <em>version vector</em>.</p>
<p>Version vector are sent from the database replicas to clients when values are read, and need to be sent back to the database when a value is subsequently written. Riak calls this <em>casual context</em>. Version vectors allow the database to distinguish between overwrites and concurrent writes.</p>
<h2 id="summary">Summary</h2>
<p>In this chapter we looked at the issue of replication. Replication can serve several
purposes:</p>
<dl>
<dt>High availability</dt>
<dd>Keeping the system running, even when one machine (or several machines, or an entire datacenter) goes down</dd>
<dt>Disconnected operation</dt>
<dd>Allowing an application to continue working when there is a network interruption</dd>
<dt>Latency</dt>
<dd>Placing data geographically close to users, so that users can interact with it faster</dd>
<dt>Scalability</dt>
<dd>Being able to handle a higher volume of reads than a single machine could handle, by performing reads on replicas</dd>
</dl>
<p>We discussed three main approaches to replication: Single-leader, Multi-leader, and leaderless.</p>
<p>Each approach has advantages and disadvantages. Single-leader replication is popular
because it is fairly easy to understand and there is no conflict resolution to worry
about. Multi-leader and leaderless replication can be more robust in the presence of faulty nodes, network interruptions, and latency spikes—at the cost of being harder
to reason about and providing only very weak consistency guarantees.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="chapter4.html" class="md-footer__link md-footer__link--prev" aria-label="Previous: 4. Encoding and evolution" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              4. Encoding and evolution
            </div>
          </div>
        </a>
      
      
        
        <a href="chapter6.html" class="md-footer__link md-footer__link--next" aria-label="Next: 6. Partitioning" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              6. Partitioning
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
  <div class="md-footer-social">
    
      
      
      <a href="mailto:theravindu@gmail.com" target="_blank" rel="noopener" title="" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M476 3.2 12.5 270.6c-18.1 10.4-15.8 35.6 2.2 43.2L121 358.4l287.3-253.2c5.5-4.9 13.3 2.6 8.6 8.3L176 407v80.5c0 23.6 28.5 32.9 42.5 15.8L282 426l124.6 52.2c14.2 6 30.4-2.9 33-18.2l72-432C515 7.8 493.3-6.8 476 3.2z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.tracking"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../../assets/javascripts/workers/search.477d984a.min.js", "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.82b56eb2.min.js"></script>
      
        <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
      
    
  </body>
</html>