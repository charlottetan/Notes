<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>raft - RKK1995's notes</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/atelier-dune-light.min.css">
        <link href="../stylesheets/extra.css" rel="stylesheet">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../index.html">RKK1995's notes</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../index.html" class="nav-link">Home</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Papers <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Storage</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../aurora/aurora.html" class="dropdown-item">aurora</a>
</li>
            
<li>
    <a href="../gfs/gfs.html" class="dropdown-item">gfs</a>
</li>
            
<li>
    <a href="../tao/tao.html" class="dropdown-item">tao</a>
</li>
            
<li>
    <a href="../craq/craq.html" class="dropdown-item">craq</a>
</li>
            
<li>
    <a href="../frangipani/frangipani.html" class="dropdown-item">frangipani</a>
</li>
            
<li>
    <a href="../spanner/spanner.html" class="dropdown-item">spanner</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Compute</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../mapreduce/mapreduce.html" class="dropdown-item">mapreduce</a>
</li>
            
<li>
    <a href="../distributedTransactions/distributedTransactions.html" class="dropdown-item">distributedTransactions</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Cluster Management</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="raft.html" class="dropdown-item active">raft</a>
</li>
            
<li>
    <a href="../zookeeper/zookeeper.html" class="dropdown-item">zookeeper</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../distributedTransactions/distributedTransactions.html" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../zookeeper/zookeeper.html" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/rkk1995/Notes/edit/master/docs/raft/raft.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#raft-in-search-of-an-understandable-consensus-algorithm" class="nav-link">Raft: In Search of an Understandable Consensus Algorithm</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#raft-basics" class="nav-link">Raft Basics</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#1-leader-election" class="nav-link">1. Leader Election</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#2-log-replication" class="nav-link">2. Log Replication</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#3-safety" class="nav-link">3. Safety</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#log-compaction" class="nav-link">Log Compaction</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#summary" class="nav-link">Summary</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="raft-in-search-of-an-understandable-consensus-algorithm"><a href="http://nil.csail.mit.edu/6.824/2020/papers/raft-extended.pdf">Raft: In Search of an Understandable Consensus Algorithm</a></h1>
<p><em>A consensus algorithm for managing a replicated log</em></p>
<p>MIT Notes <a href="http://nil.csail.mit.edu/6.824/2020/notes/l-raft.txt">Part1</a> <a href="http://nil.csail.mit.edu/6.824/2020/notes/l-raft2.txt">Part2</a><br />
MIT FAQ <a href="http://nil.csail.mit.edu/6.824/2020/papers/raft-faq.txt">Part1</a> <a href="http://nil.csail.mit.edu/6.824/2020/papers/raft2-faq.txt">Part2</a></p>
<h2 id="raft-basics">Raft Basics</h2>
<p>Raft decomposes the consensus problem into three relatively independent subproblems  </p>
<ol>
<li>Leader Election</li>
<li>Log replication</li>
<li>Safety</li>
</ol>
<ul>
<li><strong>Properties</strong><ul>
<li><strong>Election Safety</strong>: at most one leader can be elected in a given term.</li>
<li><strong>Leader Append-Only</strong>: a leader never overwrites or deletes entries in its log; it only appends new entries.</li>
<li><strong>Log Matching</strong>: if two logs contain an entry with the same index and term, then the logs are identical in all entries up through the given index.</li>
<li><strong>Leader Completeness</strong>: if a log entry is committed in a given term, then that entry will be present in the logs of the leaders for all higher-numbered terms.</li>
<li><strong>State Machine Safety</strong>: if a server has applied a log entry at a given index to its state machine, no other server will ever apply a different log entry for the same index.</li>
</ul>
</li>
</ul>
<ul>
<li>Raft divides time into terms of arbitrary length. Used extensively in leader election and log matching. </li>
</ul>
<p float="left">
  <img src="images/figure4.png" width="400" />
  <img src="images/figure5.png" width="400" /> 
</p>

<h2 id="1-leader-election">1. Leader Election</h2>
<ol>
<li>When servers start up, they begin as followers</li>
<li>Leader sends periodic heartbeats (AppendEntries RPC with no log entries) to all followers to maintain authority.</li>
<li>If follower receives no communication over <code>election timeout</code>, then it assumes there is no viable leader and begins an election to choose a new leader.</li>
<li>Begin an election: follower increments its current term and transitions to candidate state, votes for itself and issue RequestVoteRPCs in parallel to each else</li>
<li>Candidate continue in this state until one of three things happens: a. it wins b. other wins c. no one wins</li>
<li>Candidate wins if it receives the majority of votes, voting is first-come-first-served. </li>
<li>While waiting for votes, a candidate may receive an AppendEntries RPC from another server claiming to be leader. If its term is larger or equal than itself's, the candidate recognizes the leader as legit and returns to follower state</li>
<li>Case : No one wins -&gt; after timeout, new election (150ms - 300ms) - Raft uses randomized election timeouts to ensure that split votes are rare.</li>
</ol>
<h2 id="2-log-replication">2. Log Replication</h2>
<h3 id="i-steps">I. Steps</h3>
<ol>
<li>Leader appends log entry to its own log</li>
<li>Send AppendEntry to every server</li>
<li>When the entry has been safely replicated (as described below), the leader applies the entry to its state machine and returns the result of that execution to the client.</li>
</ol>
<h3 id="ii-commit">II. Commit</h3>
<ol>
<li>A log entry is committed once the leader that created the entry has replicated it on a majority of the servers<ol>
<li>Raft guarantees that committed entries are durable and will eventually be executed by all of the available state machines</li>
<li>This also commits all preceding entries in the leader's log, including entries created by previous leaders</li>
</ol>
</li>
<li>Leader keep tracks of the highest index it knows to be committed, and it includes that index in future AppendEntries RPCs. Once a follower learns that a log entry is committed, it applies the entry to its local state machine.</li>
</ol>
<h3 id="iii-inconsistency-handling">III. Inconsistency Handling</h3>
<ol>
<li>Leader maintains a <code>nextIndex</code> fields for each follower.</li>
<li>It initializes <code>nextIndex</code> values to the index just after the last one in its log.</li>
<li>If follower's log is inconsistent with the leader's, the AppendEntries RPC consistency check will fail in the next AppendEntries RPC. </li>
<li>After a rejection, the leader decrements nextIndex and retries the AppendEntries RPC </li>
</ol>
<h2 id="3-safety">3. Safety</h2>
<ul>
<li>Ensure each state machine executes same commands in the same order</li>
</ul>
<h3 id="i-election-restriction">I. Election Restriction</h3>
<ol>
<li>Candidate only elected as leader when its log is at least as up-to-date as any other log in that majority</li>
<li>Raft determines which of two logs is more up-to-date by comparing the index and term of the last entries in the logs.<ol>
<li>Term1 &gt; Term2 -&gt; Term1 wins</li>
<li>Term1 == Term2 -&gt; Log with greater length wins</li>
</ol>
</li>
</ol>
<h3 id="ii-committing-entries-from-previous-terms">II. Committing entries from previous terms</h3>
<p float="left">
  <img src="images/figure7Part1.png" width="400" />
  <img src="images/figure7Part2.png" width="400" /> 
</p>

<ol>
<li>Never commits log entries from previous terms by counting replicas.</li>
<li>Only log entries from the leader's current term are committed by counting replicas</li>
<li>Once an entry from the current term has been committed in this way, then all prior entries are committed indirectly because of the Log Matching Property.</li>
</ol>
<h2 id="log-compaction">Log Compaction</h2>
<h3 id="installsnapshot-rpc">InstallSnapshot RPC</h3>
<ul>
<li>As Raft log grows without bound, it occupies more space and takes more time to replay on server startup.</li>
<li>Snapshotting - saves entire system state to a <em>snapshot</em> on stable storage and the entire log up to that point is discarded.</li>
<li>Each server takes snapshots independently covering just the committed entries in its log.</li>
<li>Although servers normally take snapshots independently, the leader must occasionally send snapshots to followers that lag behind. This happens when the leader has already discarded the next log entry that it needs to send to a follower.</li>
</ul>
<p float="left">
  <img src="images/figure13Part1.png" width="400" />
  <img src="images/figure13Part2.png" width="400" /> 
</p>

<h2 id="summary">Summary</h2>
<p><img src="images/overview.png" alt="drawing" width="900"/></p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
