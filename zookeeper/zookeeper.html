<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>zookeeper - RKK1995's notes</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/atelier-dune-light.min.css">
        <link href="../stylesheets/extra.css" rel="stylesheet">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../index.html">RKK1995's notes</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../index.html" class="nav-link">Home</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Papers <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Storage</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../aurora/aurora.html" class="dropdown-item">aurora</a>
</li>
            
<li>
    <a href="../gfs/gfs.html" class="dropdown-item">gfs</a>
</li>
            
<li>
    <a href="../tao/tao.html" class="dropdown-item">tao</a>
</li>
            
<li>
    <a href="../craq/craq.html" class="dropdown-item">craq</a>
</li>
            
<li>
    <a href="../frangipani/frangipani.html" class="dropdown-item">frangipani</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Compute</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../mapreduce/mapreduce.html" class="dropdown-item">mapreduce</a>
</li>
            
<li>
    <a href="../distributedTransactions/distributedTransactions.html" class="dropdown-item">distributedTransactions</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Cluster Management</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../raft/raft.html" class="dropdown-item">raft</a>
</li>
            
<li>
    <a href="zookeeper.html" class="dropdown-item active">zookeeper</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../raft/raft.html" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" class="nav-link disabled">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/rkk1995/Notes/edit/master/docs/zookeeper/zookeeper.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#zookeeper-wait-free-coordination-for-internet-scale-systems" class="nav-link">ZooKeeper: Wait-free coordination for Internet-scale systems</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#basics" class="nav-link">Basics</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#service-overview" class="nav-link">Service Overview</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#implementation" class="nav-link">Implementation</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="zookeeper-wait-free-coordination-for-internet-scale-systems"><a href="http://nil.csail.mit.edu/6.824/2020/papers/zookeeper.pdf">ZooKeeper: Wait-free coordination for Internet-scale systems</a></h1>
<p><em>A service for coordinating processes of distributed applications.</em></p>
<p>MIT <a href="http://nil.csail.mit.edu/6.824/2020/notes/l-zookeeper.txt">Notes</a> , <a href="http://nil.csail.mit.edu/6.824/2020/papers/zookeeper-faq.txt">FAQ</a></p>
<h2 id="basics">Basics</h2>
<ul>
<li>ZooKeeper provides a coordination kernel for clients to implement primitives for dynamic configuration, group membership, leader election and distributed lock.</li>
<li>ZooKeeper implements non-blocking API, so a client can have multiple outstanding operations at a time.</li>
<li>ZooKeeper relaxes the conditions provided by Raft: reads are eventually consistent and can be served by replicas which increases read throughput.</li>
<li>Zookeeper guarantees :  <ul>
<li>1) linearizable writes</li>
<li>2) FIFO client ordering for all operations, all requests from a given client are executed in the order that they were sent by the client.</li>
</ul>
</li>
<li>ZooKeeper target workload read to write ratio is 2:1 to 100:1 with data in the MB range. <ul>
<li>Best for Read Heavy applications such as storing configuration information since many servers will read this data and the data is small. Also, servers will pass a <em>watch</em> flag on reads on the configuration files and will be notified whenever they change.</li>
</ul>
</li>
</ul>
<h2 id="service-overview">Service Overview</h2>
<h3 id="znode">znode</h3>
<ul>
<li>ZooKeeper provides the abstraction of a set of data nodes(znodes) organized by hierarchical namespaces.</li>
<li>znodes are in-memory data node stored in ZooKeeper. Three types of znodes:<ul>
<li>regular</li>
<li>ephemeral (automatically removed when corresponding session terminates).</li>
<li>sequential (when a file is created with a given name, ZooKeeper appends a number. ZooKeeper guarantees to never repeat a number if several clients try to write.)</li>
</ul>
</li>
<li>znodes are not for general data storage. Instead, they are used to store metadata or configuration of applications(typically 1MB).</li>
</ul>
<p><img alt="znode" src="images/znode.jpg" /></p>
<h3 id="client-api">Client API</h3>
<ul>
<li>ZooKeeper provides API for client to manipulating znodes like in a file system.</li>
<li>For read methods, ZooKeeper implements watches to allow client to receive notification of changes.  Watches are one-time triggers associated with a session(for example, <code>getData(path, watch)</code>).</li>
<li>For write methods, ZooKeeper accepts an optional expected version number(for example, <code>setData(path, data, version)</code>). If set, the write succeeds only if the actual version number of znode matches the expected one.</li>
<li>ZooKeeper client maintains session with ZooKeeper through heartbeat messages.</li>
</ul>
<h4 id="operations">Operations</h4>
<ol>
<li>create(path, data, flags(regular, ephemeral, sequential)): returns error if alraedy exists unless sequential create</li>
<li>delete(path, version): deletes if version matches</li>
<li>exists(path, watch): watch is bool</li>
<li>getData(path, watch)</li>
<li>setData(path, data, version): sets if version matches</li>
<li>getChildren(path, watch)</li>
<li>sync(path): waits for all pending writes to complete</li>
</ol>
<h2 id="implementation">Implementation</h2>
<p><img alt="components" src="images/components.jpg" /></p>
<ul>
<li>ZooKeeper service comprises an ensemble of servers that each has replicated ZooKeeper data. One is leader and the rest are followers.</li>
<li>Read requests are handled locally at each server, so it may return stale data since some committed transactions are not applied on that server yet.</li>
<li>Write requests are forwarded to leader. Leader (1) calculates the new system state to transform write requests into idempotent transactions and (2) broadcast the state changes to other servers through atomic broadcast protocol ZAB.</li>
<li>ZooKeeper uses TCP so message order is maintained by network.</li>
<li>ZooKeeper uses replay log and periodic snapshots for recoverability. Snapshots are fuzzy since ZooKeeper state is not locked when taking the snapshot. After reboot, ZooKeeper constructs a consistent snapshot by replaying all log entries from the point at which the snapshot started. Because updates in Zookeeper are idempotent and delivered in the same order, the application-state will be correct after reboot.</li>
</ul>
<h3 id="atomic-broadcast">Atomic Broadcast</h3>
<ul>
<li>Zab is an atomic broadcast protocol, uses simple majority quorums to decide on a proposal.</li>
<li>Leader executes the requests and broadcasts the change to the ZooKeeper state through Zab.</li>
<li>Zab guarantees the changes broadcast by a leader are delivered in order they were sent and all changes from previous leaders are delivered to an established leader before it broadcasts its own changes.</li>
<li>TCP for transport so message order is maintained by the network.</li>
<li>Use log to keep track of proposals as the write-ahead log for the in-memory database.</li>
</ul>
<h3 id="client-server-interactions">Client Server Interactions</h3>
<ul>
<li>Read is handled locally in memory. Each read request is processed and tagged with a zxid that corresponds to the last transaction seen by the server.</li>
<li>Zxid defines the partial order of the read requests with respect to the write requests.</li>
<li>Drawback: not guaranteeing precedence order for read operations, read may return a stale vlue. Should use sync flag to indicate follower to sync with leader.</li>
<li>Sync: place sync operation at the end of the queue of requests between the leader and the server executing the call to sync.</li>
<li>If pending queue is empty, the leader needs to issue a null transaction to commit and orders the sync after that transaction. </li>
<li>Heartbeat: send heartbeat after the session has been idle for s/3 ms and switch to a new server if it has not heard from a server for 2s/3 ms. s is session timeout in ms.</li>
</ul>
<h3 id="use-cases">Use Cases</h3>
<ul>
<li>Dynamic Configuration In A Distributed Application.<ul>
<li>Processes startup with the full pathname of z<sub>c</sub>, a znode storing dynamic configuration.</li>
<li>Set watch flag to true, read config file, upon notified and read new configuration, again set the watch flag to true</li>
</ul>
</li>
<li>Rendezvous<ul>
<li>Client creates rendezvous node, z<sub>r</sub> and the full pathnameof z<sub>r</sub> as a startup parameter of the master and worker processes.</li>
<li>When the master starts it fills in zr with information about addresses and ports it is using.</li>
<li>When workers start, they read zr with watch set to true.</li>
</ul>
</li>
<li>Group Membership<ul>
<li>Designate node, z<sub>g</sub> to represent the group. </li>
<li>When a process member of the group starts, it creates an ephemeral child znode under z<sub>g</sub>.</li>
<li>Processes can obtain group information by simply listing the children of z<sub>g</sub>.</li>
</ul>
</li>
<li>Mini Transactions - Effect is that we can achieve atomic operations. Example of atomic counter:
<div class="highlight"><pre><span></span><code><span class="k">while</span> <span class="n">true</span><span class="p">:</span>
  <span class="n">x</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">getData</span><span class="p">(</span><span class="s2">&quot;f&quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">setData</span><span class="p">(</span><span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span> <span class="k">break</span>
  <span class="n">sleep</span> 
</code></pre></div></li>
<li>Simple Locks Without Herd Effect (Scalable Locks)</li>
</ul></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
