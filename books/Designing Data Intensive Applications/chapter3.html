
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.1, mkdocs-material-7.1.9">
    
    
      
        <title>3. Storage and retrieval - RKK1995's notes</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.ca7ac06f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.f1a3b89f.min.css">
        
          
          
          <meta name="theme-color" content="">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7C&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:""}</style>
      
    
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra2.css">
    
      <link rel="stylesheet" href="../../stylesheets/headingNumbers.css">
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="dark-blue" data-md-color-accent="red">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#3-storage-and-retrieval" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../index.html" title="RKK1995&#39;s notes" class="md-header__button md-logo" aria-label="RKK1995's notes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            RKK1995's notes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              3. Storage and retrieval
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
      <div class="md-header__source">
        
<a href="https://github.com/rkk1995/Notes/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../index.html" class="md-tabs__link">
      About the Site
    </a>
  </li>

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../papers/Storage/aurora.html" class="md-tabs__link">
        Papers
      </a>
    </li>
  

  

      
        
  
  
    
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="chapter1.html" class="md-tabs__link md-tabs__link--active">
        Books
      </a>
    </li>
  

  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../System%20Design/topKHeavyHitters.html" class="md-tabs__link">
        System Design
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../index.html" title="RKK1995&#39;s notes" class="md-nav__button md-logo" aria-label="RKK1995's notes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    RKK1995's notes
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/rkk1995/Notes/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../index.html" class="md-nav__link">
        About the Site
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      <label class="md-nav__link" for="__nav_2">
        <span class="md-nav__icon md-icon"></span>
        
          Papers
        
      </label>
      <nav class="md-nav" aria-label="Papers" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          
            Papers
          
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" >
      
      <label class="md-nav__link" for="__nav_2_1">
        <span class="md-nav__icon md-icon"></span>
        
          Storage
        
      </label>
      <nav class="md-nav" aria-label="Storage" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          
            Storage
          
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../papers/Storage/aurora.html" class="md-nav__link">
        Aurora
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../papers/Storage/craq.html" class="md-nav__link">
        CRAQ
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../papers/Storage/dynamo.html" class="md-nav__link">
        Dynamo
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../papers/Storage/farm.html" class="md-nav__link">
        FaRM
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../papers/Storage/frangipani.html" class="md-nav__link">
        Frangipani
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../papers/Storage/gfs.html" class="md-nav__link">
        GFS
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../papers/Storage/memcache.html" class="md-nav__link">
        Memcache
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../papers/Storage/spanner.html" class="md-nav__link">
        Spanner
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../papers/Storage/tao.html" class="md-nav__link">
        TAO
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" >
      
      <label class="md-nav__link" for="__nav_2_2">
        <span class="md-nav__icon md-icon"></span>
        
          Compute
        
      </label>
      <nav class="md-nav" aria-label="Compute" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          
            Compute
          
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../papers/Compute/distributedTransactions.html" class="md-nav__link">
        Distributed Transactions
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../papers/Compute/mapreduce.html" class="md-nav__link">
        MapReduce
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3" type="checkbox" id="__nav_2_3" >
      
      <label class="md-nav__link" for="__nav_2_3">
        <span class="md-nav__icon md-icon"></span>
        
          Cluster Management
        
      </label>
      <nav class="md-nav" aria-label="Cluster Management" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          
            Cluster Management
          
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../papers/Cluster%20Management/raft.html" class="md-nav__link">
        Raft
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../papers/Cluster%20Management/zookeeper.html" class="md-nav__link">
        ZooKeeper
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      <label class="md-nav__link" for="__nav_3">
        <span class="md-nav__icon md-icon"></span>
        
          Books
        
      </label>
      <nav class="md-nav" aria-label="Books" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          
            Books
          
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1" type="checkbox" id="__nav_3_1" checked>
      
      <label class="md-nav__link" for="__nav_3_1">
        <span class="md-nav__icon md-icon"></span>
        
          Designing Data Intensive Applications
        
      </label>
      <nav class="md-nav" aria-label="Designing Data Intensive Applications" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          
            Designing Data Intensive Applications
          
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="chapter1.html" class="md-nav__link">
        1. Reliable, scalable, and maintainable applications
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="chapter2.html" class="md-nav__link">
        2. Data Models and Query Languages
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          <span class="md-nav__icon md-icon"></span>
          
            <a href="chapter3.html" class="md-nav__link md-nav__link--active"
              style="margin: initial; padding: initial; pointer-events: initial">
          
            3. Storage and retrieval
          </a>
        </label>
      
      <a href="chapter3.html" class="md-nav__link md-nav__link--active">
        3. Storage and retrieval
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#data-structures-that-power-up-your-database" class="md-nav__link">
    Data structures that power up your database
  </a>
  
    <nav class="md-nav" aria-label="Data structures that power up your database">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hash-indexes" class="md-nav__link">
    Hash Indexes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sstables-and-lsm-trees" class="md-nav__link">
    SSTables and LSM-Trees
  </a>
  
    <nav class="md-nav" aria-label="SSTables and LSM-Trees">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#constructing-and-maintaining-sstables" class="md-nav__link">
    Constructing and maintaining SSTables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#making-an-lsm-tree-out-of-sstables" class="md-nav__link">
    Making an LSM-tree out of SSTables
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b-trees" class="md-nav__link">
    B-trees
  </a>
  
    <nav class="md-nav" aria-label="B-trees">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#making-b-trees-reliable" class="md-nav__link">
    Making B-trees reliable
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b-trees-and-lsm-trees" class="md-nav__link">
    B-trees and LSM-trees
  </a>
  
    <nav class="md-nav" aria-label="B-trees and LSM-trees">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#advantages-of-lsm-trees" class="md-nav__link">
    Advantages of LSM-trees
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#downsides-of-lsm-trees" class="md-nav__link">
    Downsides of LSM-trees
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#other-indexing-structures" class="md-nav__link">
    Other indexing structures
  </a>
  
    <nav class="md-nav" aria-label="Other indexing structures">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#keeping-everything-in-memory" class="md-nav__link">
    Keeping everything in memory
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#transaction-processing-or-analytics" class="md-nav__link">
    Transaction processing or analytics?
  </a>
  
    <nav class="md-nav" aria-label="Transaction processing or analytics?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#data-warehousing" class="md-nav__link">
    Data warehousing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#column-oriented-storage" class="md-nav__link">
    Column-oriented storage
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="chapter4.html" class="md-nav__link">
        4. Encoding and evolution
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="chapter5.html" class="md-nav__link">
        5. Replication
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="chapter6.html" class="md-nav__link">
        6. Partitioning
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="chapter7.html" class="md-nav__link">
        7. Transactions
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="chapter8.html" class="md-nav__link">
        8. The Trouble With Distributed Systems
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      <label class="md-nav__link" for="__nav_4">
        <span class="md-nav__icon md-icon"></span>
        
          System Design
        
      </label>
      <nav class="md-nav" aria-label="System Design" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          
            System Design
          
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../System%20Design/topKHeavyHitters.html" class="md-nav__link">
        Top K Heavy Hitters
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#data-structures-that-power-up-your-database" class="md-nav__link">
    Data structures that power up your database
  </a>
  
    <nav class="md-nav" aria-label="Data structures that power up your database">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hash-indexes" class="md-nav__link">
    Hash Indexes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sstables-and-lsm-trees" class="md-nav__link">
    SSTables and LSM-Trees
  </a>
  
    <nav class="md-nav" aria-label="SSTables and LSM-Trees">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#constructing-and-maintaining-sstables" class="md-nav__link">
    Constructing and maintaining SSTables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#making-an-lsm-tree-out-of-sstables" class="md-nav__link">
    Making an LSM-tree out of SSTables
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b-trees" class="md-nav__link">
    B-trees
  </a>
  
    <nav class="md-nav" aria-label="B-trees">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#making-b-trees-reliable" class="md-nav__link">
    Making B-trees reliable
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b-trees-and-lsm-trees" class="md-nav__link">
    B-trees and LSM-trees
  </a>
  
    <nav class="md-nav" aria-label="B-trees and LSM-trees">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#advantages-of-lsm-trees" class="md-nav__link">
    Advantages of LSM-trees
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#downsides-of-lsm-trees" class="md-nav__link">
    Downsides of LSM-trees
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#other-indexing-structures" class="md-nav__link">
    Other indexing structures
  </a>
  
    <nav class="md-nav" aria-label="Other indexing structures">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#keeping-everything-in-memory" class="md-nav__link">
    Keeping everything in memory
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#transaction-processing-or-analytics" class="md-nav__link">
    Transaction processing or analytics?
  </a>
  
    <nav class="md-nav" aria-label="Transaction processing or analytics?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#data-warehousing" class="md-nav__link">
    Data warehousing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#column-oriented-storage" class="md-nav__link">
    Column-oriented storage
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/rkk1995/Notes/edit/master/docs/books/Designing Data Intensive Applications/chapter3.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="3-storage-and-retrieval">3. Storage and retrieval</h1>
<p>Databases need to do two things: store the data and give the data back to you.</p>
<h2 id="data-structures-that-power-up-your-database">Data structures that power up your database</h2>
<p>Many databases use a <em>log</em>, which is append-only data file. Real databases have more issues to deal with tho (concurrency control, reclaiming disk space so the log doesn't grow forever and handling errors and partially written records).</p>
<blockquote>
<p>A <em>log</em> is an append-only sequence of records</p>
</blockquote>
<p>In order to efficiently find the value for a particular key, we need a different data structure: an <em>index</em>. An index is an <em>additional</em> structure that is derived from the primary data.</p>
<p>Well-chosen indexes speed up read queries, but every index slows down writes.</p>
<h3 id="hash-indexes">Hash Indexes</h3>
<p>The simplest possible indexing strategy is this: keep an in-memory hash map where every key is mapped to a byte offset in the data file—the location at which the value can be found. Whenever you append a new key-value pair to the file, you also update the hash map to reflect the offset of the data you just wrote (this works both for inserting new keys and for updating existing keys). When you want to look up a value, use the hash map to find the offset in the data file, seek to that location, and read the value.</p>
<p>So we only ever append to a file - how do we avoid eventually running out of disk space?</p>
<p>A good solution is to break the log into segments of a certain size by closing a segment file when it reaches a certain size, and making subsequent writes to a new segment file. We can then perform compaction on these segments, while merging segments simultaneously, as illustrated in Figure 3-3.</p>
<p><img alt="Figure 3-3" src="images/3/figure3-3.png" /></p>
<p>After the merging process is complete, we switch read requests to use the new merged segment instead of the old segments, and the old segment files can simply be deleted.</p>
<p>Each segment now has its own in-memory hash table, mapping keys to file offsets. In order to find a value for a key, we first check the most recent segment hash map; if the key is not present we check the second-most recent segment and so on. The merging process keeps the number of segments small, so lookups don't need to check many hash maps.</p>
<p>Some issues that are important in a real implementation:</p>
<ul>
<li>File format. It is simpler to use binary format.</li>
<li>Deleting records. Append special deletion record to the data file (<em>tombstone</em>) that tells the merging process to discard previous values.</li>
<li>Crash recovery. If restarted, the in-memory hash maps are lost. You can recover from reading each segment but that would take long time. Bitcask speeds up recovery by storing a snapshot of each segment hash map on disk.</li>
<li>Partially written records. The database may crash at any time. Bitcask includes checksums allowing corrupted parts of the log to be detected and ignored.</li>
<li>Concurrency control. As writes are appended to the log in a strictly sequential order, a common implementation is to have a single writer thread. Segments are immutable, so they can be read concurrently by multiple threads.</li>
</ul>
<p>Append-only design turns out to be good for several reasons:</p>
<ul>
<li>Appending and segment merging are sequential write operations, much faster than random writes, especially on magnetic spinning-disks.</li>
<li>Concurrency and crash recovery are much simpler.</li>
<li>Merging old segments avoids files getting fragmented over time.</li>
</ul>
<p>Hash table has its limitations too:</p>
<ul>
<li>The hash table must fit in memory. It is difficult to make an on-disk hash map perform well.</li>
<li>Range queries are not efficient.</li>
</ul>
<h3 id="sstables-and-lsm-trees">SSTables and LSM-Trees</h3>
<p>We introduce a new requirement to segment files: we require that the sequence of key-value pairs is <em>sorted by key</em>.</p>
<p>We call this <em>Sorted String Table</em>, or <em>SSTable</em>. We require that each key only appears once within each merged segment file (compaction already ensures that). SSTables have few big advantages over log segments with hash indexes</p>
<ol>
<li><strong>Merging segments is simple and efficient</strong> (we can use algorithms like <em>mergesort</em>). When multiple segments contain the same key, we can keep the value from the most recent segment and discard the values in older segments.</li>
<li><strong>You no longer need to keep an index of all the keys in memory.</strong> For a key like <code>handiwork</code>, when you know the offsets for the keys <code>handback</code> and <code>handsome</code>, you know <code>handiwork</code> must appear between those two. You can jump to the offset for <code>handback</code> and scan from there until you find <code>handiwork</code>, if not, the key is not present. You still need an in-memory index to tell you the offsets for some of the keys. One key for every few kilobytes of segment file is sufficient.</li>
<li>Since read requests need to scan over several key-value pairs in the requested range anyway, <strong>it is possible to group those records into a block and compress it</strong> before writing it to disk. This saves disk space and reduces I/O bandwidth use.</li>
</ol>
<h4 id="constructing-and-maintaining-sstables">Constructing and maintaining SSTables</h4>
<p>How do we get the data sorted in the first place? With red-black trees or AVL trees, you can insert keys in any order and read them back in sorted order.</p>
<ul>
<li>When a write comes in, add it to an in-memory balanced tree structure (<em>memtable</em>).</li>
<li>When the memtable gets bigger than some threshold (~ few megabytes), write it out to disk as an <em>SSTable</em> file. Writes can continue to a new memtable instance.</li>
<li>On a read request, try to find the key in the memtable, then in the most recent on-disk segment, then in the next-older segment, etc.</li>
<li>From time to time, run merging and compaction in the background to discard overwritten and deleted values.</li>
</ul>
<p>If the database crashes, the most recent writes are lost. We can keep a separate log on disk to which every write is immediately appended. That log is not in sorted order, but that doesn't matter, because its only purpose is to restore the memtable after crash. Every time the memtable is written out to an SSTable, the log can be discarded.</p>
<h4 id="making-an-lsm-tree-out-of-sstables">Making an LSM-tree out of SSTables</h4>
<p>The algorithm described here is essentialy what is used in LevelDB and RocksDB (backs Facebook MySQL), key-value storage engine libraries. Similar storage engines are used in Cassandra and Hbase both of which were inspired by Google's Bigtable (which introduced SSTable and memtable)</p>
<dl>
<dt>Log Structure Merge-Trees</dt>
<dd>Storage engines that are based on this principle of merging and compacting sorted files.</dd>
</dl>
<p>LSM-tree algorithm can be slow when looking up keys that don't exist in the database. To optimise this, storage engines often use additional <em>Bloom filters</em> (a memory-efficient data structure for approximating the contents of a set).</p>
<p>There are also different strategies to determine the order and timing of how SSTables are compacted and merged. Mainly two <em>size-tiered</em> and <em>leveled</em> compaction. LevelDB and RocksDB use leveled compaction, HBase use size-tiered, and Cassandra supports both. In size-tiered compaction, newer and smaller SSTables are successively merged into older and larger SSTables. In leveled compaction, the key range is split up into smaller SSTables and older data is moved into separate "levels", which allows the compaction to use less disk space.</p>
<h5 id="tiering-size-vs-leveling-compaction">Tiering (size) vs Leveling Compaction</h5>
<p>Below is not from the book but from a great video lecture <a href="https://www.youtube.com/watch?v=b6SI8VbcT4w&amp;t=411s">Scaling Write-Intensive Key-Value Stores</a></p>
<p>The more greedy we want merging to be, the higher the cost of writes is going to be because we're going to be on average merging each entry more times. But the more greedy merging is going to be, we will have better reads because reads will have fewer runs in the system to have access.</p>
<dl>
<dt>Tiering</dt>
<dd>Write optimized</dd>
<dt>Leveling</dt>
<dd>Read optimized</dd>
</dl>
<p>In a <em>Tiered</em> LSM tree, each level just gatheres runs from the previous level and only when it reaches capacity does it merge these runs. We do less work per write here. On the other hand, with a <em>Level</em> LSM tree, a merge operation occurs at a level as soon as a new run comes in from the previous level.</p>
<p><img alt="Tiering vs Leveling" src="images/3/youtube.png" /></p>
<p>When R = 2, the performances converge as there would only be 1 run per level. If R becomes very large, we never merge so it becomes a log. </p>
<p><img alt="Graph" src="images/3/graph.png" /></p>
<h3 id="b-trees">B-trees</h3>
<p>This is the most widely used indexing structure. B-tress keep key-value pairs sorted by key, which allows efficient key-value lookups and range queries.</p>
<p>The log-structured indexes break the database down into variable-size <em>segments</em> typically several megabytes or more. B-trees break the database down into fixed-size <em>blocks</em> or <em>pages</em>, traditionally 4KB.</p>
<p><img align="right" alt="Figure 3-6" src="images/3/figure3-6.png" /></p>
<p>One page is designated as the <em>root</em> and you start from there. The page contains several keys and references to child pages.</p>
<p>If you want to update the value for an existing key in a B-tree, you search for the leaf page containing that key, change the value in that page, and write the page back to disk. If you want to add new key, find the page and add it to the page. If there isn't enough free space in the page to accommodate the new key, it is split in two half-full pages, and the parent page is updated to account for the new subdivision of key ranges.</p>
<p>Trees remain <em>balanced</em>. A B-tree with <em>n</em> keys always has a depth of <em>O</em>(log <em>n</em>). Also depends on branching factor.</p>
<h4 id="making-b-trees-reliable">Making B-trees reliable</h4>
<p>The basic underlying write operation of a B-tree is to overwrite a page on disk with new data. It is assumed that the overwrite does not change the location of the page, all references to that page remain intact. This is a big contrast to log-structured indexes such as LSM-trees, which only append to files.</p>
<p>Some operations require several different pages to be overwritten. When you split a page, you need to write the two pages that were split, and also overwrite their parent. If the database crashes after only some of the pages have been written, you end up with a corrupted index.</p>
<p>It is common to include an additional data structure on disk: a <em>write-ahead log</em> (WAL, also know as the <em>redo log</em>).</p>
<p>Careful concurrency control is required if multiple threads are going to access, typically done protecting the tree internal data structures with <em>latches</em> (lightweight locks).</p>
<h3 id="b-trees-and-lsm-trees">B-trees and LSM-trees</h3>
<p>LSM-trees are typically faster for writes, whereas B-trees are thought to be faster for reads. Reads are typically slower on LSM-tress as they have to check several different data structures and SSTables at different stages of compaction.</p>
<h4 id="advantages-of-lsm-trees">Advantages of LSM-trees</h4>
<ul>
<li>LSM-trees are typically able to sustain higher write throughput than B-trees, party because they sometimes have lower <em>write amplification</em>: a write to the database results in multiple writes to disk. The more a storage engine writes to disk, the fewer writes per second it can handle.</li>
<li>LSM-trees can be compressed better, and thus often produce smaller files on disk than B-trees. B-trees tend to leave disk space unused due to fragmentation: when a page is split or when a row cannot fit into an existing page, some space in a page remains unused. Since LSM trees are not page oriented and periodicially rewrite SSTables to remove fragmentation, they have lower storage overhead, especially when using leveled compaction.</li>
</ul>
<h4 id="downsides-of-lsm-trees">Downsides of LSM-trees</h4>
<ul>
<li>Compaction process can sometimes interfere with the performance of ongoing reads and writes. B-trees can be more predictable. The bigger the database, the the more disk bandwidth is required for compaction. Compaction cannot keep up with the rate of incoming writes, if not configured properly you can run out of disk space.</li>
<li>On B-trees, each key exists in exactly one place in the index. This offers strong transactional semantics. Transaction isolation is implemented using locks on ranges of keys, and in a B-tree index, those locks can be directly attached to the tree.</li>
</ul>
<h3 id="other-indexing-structures">Other indexing structures</h3>
<p>We've only discussed key-value indexes, which are like <em>primary key</em> index. There are also <em>secondary indexes</em>.</p>
<p>A secondary index can be easily constructed from a key-value index. The main difference is that in a secondary index, the indexed values are not necessarily unique. There are two ways of doing this: making each value in the index a list of matching row identifiers or by making each key unique by appending a row identifier to it.</p>
<h4 id="keeping-everything-in-memory">Keeping everything in memory</h4>
<p>Disks have two significant advantages: they are durable, and they have lower cost per gigabyte than RAM.</p>
<p>It's quite feasible to keep them entirely in memory, this has lead to <em>in-memory</em> databases.</p>
<p>Key-value stores, such as Memcached are intended for cache only, it's acceptable for data to be lost if the machine is restarted. Other in-memory databases aim for durability, with special hardware, writing a log of changes to disk, writing periodic snapshots to disk or by replicating in-memory sate to other machines.</p>
<p>When an in-memory database is restarted, it needs to reload its state, either from disk or over the network from a replica. The disk is merely used as an append-only log for durability, and reads are served entirely from memory.</p>
<p>Products such as VoltDB, MemSQL, and Oracle TimesTime are in-memory databases. Redis and Couchbase provide weak durability.</p>
<p>Counterintuitively, the performance advantage of in-memory databases is not due to the fact that they don’t need to read from disk. Even a disk-based storage engine may never need to read from disk if you have enough memory, because the operating system caches recently used disk blocks in memory anyway. Rather, they can be faster because they can avoid the overheads of encoding in-memory data structures in a form that can be written to disk</p>
<h2 id="transaction-processing-or-analytics">Transaction processing or analytics?</h2>
<p>A <em>transaction</em> is a group of reads and writes that form a logical unit, this pattern became known as <em>online transaction processing</em> (OLTP).</p>
<p><em>Data analytics</em> has very different access patterns. A query would need to scan over a huge number of records, only reading a few columns per record, and calculates aggregate statistics.</p>
<p>These queries are often written by business analysts, and fed into reports. This pattern became known for <em>online analytics processing</em> (OLAP).</p>
<h3 id="data-warehousing">Data warehousing</h3>
<p>A <em>data warehouse</em> is a separate database that analysts can query to their heart's content without affecting OLTP operations. It contains read-only copy of the dat in all various OLTP systems in the company. Data is extracted out of OLTP databases (through periodic data dump or a continuous stream of update), transformed into an analysis-friendly schema, cleaned up, and then loaded into the data warehouse (process <em>Extract-Transform-Load</em> or ETL).</p>
<p>A data warehouse is most commonly relational, but the internals of the systems can look quite different.</p>
<p>Amazon RedShift is hosted version of ParAccel. Apache Hive, Spark SQL, Cloudera Impala, Facebook Presto, Apache Tajo, and Apache Drill. Some of them are based on ideas from Google's Dremel.</p>
<p>Data warehouses are used in fairly formulaic style known as a <em>star schema</em>.</p>
<p>Facts are captured as individual events, because this allows maximum flexibility of analysis later. The fact table can become extremely large.</p>
<p>Dimensions represent the <em>who</em>, <em>what</em>, <em>where</em>, <em>when</em>, <em>how</em> and <em>why</em> of the event.</p>
<p>The name "star schema" comes from the fact than when the table relationships are visualised, the fact table is in the middle, surrounded by its dimension tables, like the rays of a star.</p>
<p>Fact tables often have over 100 columns, sometimes several hundred. Dimension tables can also be very wide.</p>
<h2 id="column-oriented-storage">Column-oriented storage</h2>
<p>In a row-oriented storage engine, when you do a query that filters on a specific field, the engine will load all those rows with all their fields into memory, parse them and filter out the ones that don't meet the requirement. This can take a long time.</p>
<p><em>Column-oriented storage</em> is simple: don't store all the values from one row together, but store all values from each <em>column</em> together instead. If each column is stored in a separate file, a query only needs to read and parse those columns that are used in a query, which can save a lot of work.</p>
<p>Column-oriented storage often lends itself very well to compression as the sequences of values for each column look quite repetitive, which is a good sign for compression. A technique that is particularly effective in data warehouses is <em>bitmap encoding</em>.</p>
<p>Bitmap indexes are well suited for all kinds of queries that are common in a data warehouse.</p>
<blockquote>
<p>Cassandra and HBase have a concept of <em>column families</em>, which they inherited from Bigtable.</p>
</blockquote>
<p>Besides reducing the volume of data that needs to be loaded from disk, column-oriented storage layouts are also good for making efficient use of CPU cycles (<em>vectorised processing</em>).</p>
<p><strong>Column-oriented storage, compression, and sorting helps to make read queries faster and make sense in data warehouses, where most of the load consist on large read-only queries run by analysts. The downside is that writes are more difficult.</strong></p>
<p>An update-in-place approach, like B-tree use, is not possible with compressed columns. If you insert a row in the middle of a sorted table, you would most likely have to rewrite all column files.</p>
<p>It's worth mentioning <em>materialised aggregates</em> as some cache of the counts ant the sums that queries use most often. A way of creating such a cache is with a <em>materialised view</em>, on a relational model this is usually called a <em>virtual view</em>: a table-like object whose contents are the results of some query. A materialised view is an actual copy of the query results, written in disk, whereas a virtual view is just a shortcut for writing queries.</p>
<p>When the underlying data changes, a materialised view needs to be updated, because it is denormalised copy of the data. Database can do it automatically, but writes would become more expensive.</p>
<p>A common special case of a materialised view is know as a <em>data cube</em> or <em>OLAP cube</em>, a grid of aggregates grouped by different dimensions.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" title="Back to top" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
          </a>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="chapter2.html" class="md-footer__link md-footer__link--prev" aria-label="Previous: 2. Data Models and Query Languages" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              2. Data Models and Query Languages
            </div>
          </div>
        </a>
      
      
        
        <a href="chapter4.html" class="md-footer__link md-footer__link--next" aria-label="Next: 4. Encoding and evolution" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              4. Encoding and evolution
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
  <div class="md-footer-social">
    
      
      
      <a href="mailto:theravindu@gmail.com" target="_blank" rel="noopener" title="" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M476 3.2 12.5 270.6c-18.1 10.4-15.8 35.6 2.2 43.2L121 358.4l287.3-253.2c5.5-4.9 13.3 2.6 8.6 8.3L176 407v80.5c0 23.6 28.5 32.9 42.5 15.8L282 426l124.6 52.2c14.2 6 30.4-2.9 33-18.2l72-432C515 7.8 493.3-6.8 476 3.2z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.tabs.link", "navigation.instant", "navigation.tabs", "navigation.tracking", "navigation.top", "search.highlight", "search.share", "search.suggest"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.477d984a.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.82b56eb2.min.js"></script>
      
        <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
      
    
  </body>
</html>